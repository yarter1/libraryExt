<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>UnityPackage Viewer (private Drive)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.110.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.110.0/examples/js/loaders/FBXLoader.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/utif@3.1.0/UTIF.min.js"></script>

  <style>
    body { margin:0; background:#222; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    .viewer-outer { width:90vw; max-width:880px; height:90vw; max-height:880px; margin:40px auto; border-radius:18px; background:#fff; box-shadow:0 8px 44px #0001,0 2px 8px #7772; display:flex; flex-direction:column; overflow:hidden; position:relative; }
    .viewer-inner { flex:1; display:flex; position:relative; min-height:320px; }
    .sidebar { width:360px; max-width:95vw; background:#fff; border-right:1px solid #e2e2e2; position:absolute; left:0; top:0; bottom:0; z-index:22; transform:translateX(-105%); transition:transform .35s ease; display:flex; flex-direction:column; }
    .sidebar.open { transform:translateX(0); }
    .sidebar-header { padding:14px 16px; background:#e3f2fd; border-bottom:1px solid #e2e2e2; color:#155fa0; font-weight:700; }
    .sidebar-content { flex:1; overflow:auto; padding:10px 12px 16px; }
    .toggle-btn { position:absolute; left:0; top:70px; width:36px; height:110px; z-index:30; background:#1a73e8; color:#fff; border:none; border-radius:0 10px 10px 0; cursor:pointer; box-shadow:5px 5px 10px #0005; }
    #fbxToolbar { display:flex; gap:8px; align-items:center; padding:10px 12px; background:#fafcff; border-bottom:1px solid #e2e2e2; }
    #houseName { flex:1; text-align:center; background:#1a73e8; color:#fff; border-radius:10px; padding:6px 10px; font-weight:700; user-select:none; }
    #lodSelect { padding:6px 10px; border-radius:10px; background:#1a73e8; color:#fff; border:none; }
    #viewModeButtons button { padding:6px 8px; border:none; border-radius:6px; background:#1a73e8; color:#fff; cursor:pointer; }
    #viewModeButtons button:hover { filter:brightness(.9); }
    #fbxViewerContainer { flex:1; display:flex; align-items:center; justify-content:center; background:#f3f3f4; }
    #fbxViewer { width:100%; height:100%; min-height:320px; }
    .category { margin:12px 0; background:#eef5ff; border-radius:10px; padding:10px; }
    .category h3 { margin:0 0 8px; color:#1a73e8; }
    .category ul { list-style:none; margin:0; padding:0; max-height:260px; overflow:auto; }
    .category li { display:flex; justify-content:space-between; padding:6px 0; border-top:1px solid #dbe9ff; }
    .category li:first-child { border-top:none; }
    .category a { color:#1a73e8; text-decoration:none; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .download-all-btn, .category button { width:100%; margin-top:8px; background:#1a73e8; color:#fff; font-weight:700; border:none; border-radius:8px; padding:10px 0; cursor:pointer; }
    #modal { display:none; }
  </style>
</head>
<body>
  <div class="viewer-outer">
    <div class="viewer-inner">
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">Asset list</div>
        <div class="sidebar-content">
          <div id="dropZone" style="padding:10px;border:1px dashed #9bbcff;border-radius:8px;background:#f7fbff;margin-bottom:10px;text-align:center;cursor:pointer;">
            Перетащи <b>.unitypackage</b> или кликни
          </div>
          <input type="file" id="fileInput" style="display:none" accept=".unitypackage" />
          <div id="fileList"></div>
          <button id="downloadAllBtn" class="download-all-btn" style="display:none">Download ALL as ZIP</button>
        </div>
      </aside>
      <button class="toggle-btn" id="toggleSidebarBtn">Files ❯</button>

      <section class="main-viewer-panel" style="flex:1;display:flex;flex-direction:column;">
        <div id="fbxToolbar">
          <select id="lodSelect"></select>
          <div id="houseName">Loading...</div>
          <div id="viewModeButtons">
            <button data-mode="wire">Wireframe</button>
            <button data-mode="gray">Gray</button>
            <button data-mode="lit">Lit</button>
          </div>
        </div>
        <div id="fbxViewerContainer"><div id="fbxViewer"></div></div>
      </section>
    </div>

    <div style="padding:10px 12px; background:#fff;">
      <input type="text" id="gdriveId" style="width:340px" value="1Dm1n2SeWan4KtWT7PTtym2Kq-lDR1xSD" placeholder="ID файла Google Drive">
      <button id="loadFromDriveBtn">Загрузить с Google Drive</button>
    </div>
  </div>

  <div id="modal"></div>

  <script>
    // === ВАЖНО: ваш URL веб-приложения GAS и секретный токен ===
    const WEB_APP_URL = 'https://script.google.com/macros/s/PASTE_YOUR_EXEC_URL_HERE/exec';
    const API_TOKEN   = 'PASTE_YOUR_API_TOKEN_HERE'; // такой же, как в Script properties

    const sidebar = document.getElementById('sidebar');
    document.getElementById('toggleSidebarBtn').onclick = () => sidebar.classList.toggle('open');

    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const fileList  = document.getElementById('fileList');
    const downloadAllBtn = document.getElementById('downloadAllBtn');

    class UnityExtractClient {
      async extract(arrayBuffer) {
        const unzipped = pako.ungzip(new Uint8Array(arrayBuffer));
        return this._parseTar(unzipped);
      }
      _parseTar(data) {
        const files = {}; let off = 0;
        while (off < data.length) {
          const header = data.slice(off, off + 512);
          const name = new TextDecoder().decode(header.slice(0, 100)).replace(/\0/g, '').trim();
          if (!name) break;
          const size = parseInt(new TextDecoder().decode(header.slice(124, 136)).replace(/\0/g,'').trim(), 8) || 0;
          if (size > 0) files[name] = data.slice(off + 512, off + 512 + size);
          off += 512 + Math.ceil(size / 512) * 512;
        }
        return this._convert(files);
      }
      _convert(files) {
        const out = {};
        const dirs = Object.keys(files).filter(f => f.endsWith('/pathname'));
        for (const d of dirs) {
          const base = d.replace('/pathname','');
          const newPath = new TextDecoder().decode(files[d]).split('\n')[0];
          if (files[base + '/asset']) out[newPath] = files[base + '/asset'];
          if (files[base + '/asset.meta']) out[newPath + '.meta'] = files[base + '/asset.meta'];
          else if (files[base + '/metaData']) out[newPath + '.meta'] = files[base + '/metaData'];
        }
        return out;
      }
    }
    const extractor = new UnityExtractClient();

    let extractedFiles = {};
    let fbxFiles = [];
    let renderer, scene, camera, currentMesh, currentMode = 'lit';

    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.style.background = '#eef6ff'; });
    dropZone.addEventListener('dragleave', () => { dropZone.style.background = '#f7fbff'; });
    dropZone.addEventListener('drop', async e => {
      e.preventDefault(); dropZone.style.background = '#f7fbff';
      if (e.dataTransfer.files.length) await handleUnitypackage(e.dataTransfer.files[0]);
    });
    fileInput.addEventListener('change', async e => { if (e.target.files.length) await handleUnitypackage(e.target.files[0]); });

    async function handleUnitypackage(file) {
      if (!file.name.endsWith('.unitypackage')) { alert('Нужен файл .unitypackage'); return; }
      fileList.innerHTML = 'Processing...';
      extractedFiles = await extractor.extract(await file.arrayBuffer());
      buildListsAndUI();
    }

    function buildListsAndUI() {
      fileList.innerHTML = '';
      fbxFiles = [];
      const byExt = {};
      for (const [path, content] of Object.entries(extractedFiles)) {
        if (path.endsWith('.meta')) continue;
        const ext = path.split('.').pop().toLowerCase();
        if (!byExt[ext]) byExt[ext] = [];
        byExt[ext].push({ path, content });
        if (ext === 'fbx') fbxFiles.push({ fileName: path.split('/').pop(), path, content });
      }

      for (const ext of Object.keys(byExt)) {
        if (ext === 'mat' || ext === 'prefab' || ext === 'shader') continue;
        const arr = byExt[ext];

        const wrap = document.createElement('div'); wrap.className = 'category';
        wrap.innerHTML = `<h3>${ext === 'tif' ? 'Textures' : ext.toUpperCase()}</h3>`;
        const ul = document.createElement('ul');

        for (const f of arr) {
          const li = document.createElement('li');
          const a = document.createElement('a'); a.href="#"; a.textContent = f.path.split('/').pop(); a.title = f.path;
          const size = document.createElement('span'); size.textContent = `(${formatSize(f.content.byteLength)})`;
          a.onclick = e => {
            e.preventDefault();
            if (ext === 'fbx') showFBXByName(f.path.split('/').pop());
            else if (ext === 'tif') previewTiff(f.content);
            else downloadAny(f.path, f.content);
          };
          li.appendChild(a); li.appendChild(size); ul.appendChild(li);
        }

        wrap.appendChild(ul);
        const btn = document.createElement('button'); btn.textContent = `Download ${ext.toUpperCase()} as ZIP`;
        btn.onclick = () => downloadZip(ext, arr);
        wrap.appendChild(btn);
        fileList.appendChild(wrap);
      }
      downloadAllBtn.style.display = 'block';

      fbxFiles.sort((a,b) => orderKey(a.fileName) - orderKey(b.fileName));
      const lodSelect = document.getElementById('lodSelect'); lodSelect.innerHTML = '';
      fbxFiles.forEach((f,i) => {
        const opt=document.createElement('option');
        opt.value=i; opt.textContent=f.fileName.replace(/_/g,' ').replace(/\.fbx$/i,'');
        lodSelect.appendChild(opt);
      });
      lodSelect.onchange = () => showFbxByIndex(+lodSelect.value);

      if (fbxFiles.length) {
        const idx = fbxFiles.findIndex(f => /lod0/i.test(f.fileName));
        showFbxByIndex(idx >= 0 ? idx : 0);
        document.getElementById('houseName').textContent = (fbxFiles[idx>=0?idx:0].fileName.split('_lod')[0]) || 'Model';
      } else {
        document.getElementById('houseName').textContent = 'No FBX found';
      }
    }

    function orderKey(n){ return /lod0/i.test(n)?0:/lod1/i.test(n)?1:/lod2/i.test(n)?2:/shadow/i.test(n)?3:/gamecoll/i.test(n)?4:5; }

    document.getElementById('loadFromDriveBtn').onclick = async () => {
      const raw = document.getElementById('gdriveId').value.trim();
      const id = (raw.match(/[-\w]{25,}/) || [raw])[0];
      await fetchDriveAndOpen(id);
    };

    async function fetchDriveAndOpen(fileId) {
      try {
        fileList.innerHTML = 'Downloading from Drive...';
        const url = `${WEB_APP_URL}?p=drive&id=${encodeURIComponent(fileId)}&key=${encodeURIComponent(API_TOKEN)}`;
        const res = await fetch(url, { method: 'GET' });
        if (!res.ok) { throw new Error(`HTTP ${res.status}`); }
        const json = await res.json();
        if (!json.ok) { throw new Error(json.error || 'Drive error'); }
        const bytes = base64ToBytes(json.data);
        extractedFiles = await extractor.extract(bytes.buffer);
        buildListsAndUI();
        sidebar.classList.add('open');
      } catch (err) {
        console.error(err);
        alert('Не удалось загрузить файл с Drive: ' + err.message);
      }
    }

    let renderer, scene, camera, currentMesh, currentMode = 'lit';
    function ensureThree() {
      if (renderer) return;
      const container = document.getElementById('fbxViewer');
      const w = container.clientWidth || 600, h = container.clientHeight || 600;
      renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
      renderer.setSize(w,h); renderer.setClearColor(0xeeeeee,1);
      container.appendChild(renderer.domElement);
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(45, w/h, .1, 10000);
      camera.position.set(0,1,5);
      scene.add(new THREE.AmbientLight(0xffffff,.9));
      const dl = new THREE.DirectionalLight(0xffffff,.9); dl.position.set(5,10,7); scene.add(dl);

      let dragging=false, px=0, py=0, theta=0.6, phi=0.3, radius=8, center=new THREE.Vector3();
      function upd(){ camera.position.x=center.x+radius*Math.sin(theta)*Math.cos(phi); camera.position.y=center.y+radius*Math.sin(phi); camera.position.z=center.z+radius*Math.cos(theta)*Math.cos(phi); camera.lookAt(center); }
      renderer.domElement.onmousedown=e=>{ dragging=true; px=e.clientX; py=e.clientY; };
      renderer.domElement.onmouseup=()=>{ dragging=false; };
      renderer.domElement.onmousemove=e=>{ if(!dragging)return; theta-=(e.clientX-px)*.01; phi-=(e.clientY-py)*.01; phi=Math.max(-Math.PI/2+.05,Math.min(Math.PI/2-.05,phi)); px=e.clientX; py=e.clientY; upd(); };
      renderer.domElement.onwheel=e=>{ radius*=e.deltaY>0?1.1:0.9; radius=Math.max(.1,Math.min(3000,radius)); upd(); };
      (function loop(){ renderer.render(scene,camera); requestAnimationFrame(loop); })();
      ensureThree.updateTo = obj => { const box=new THREE.Box3().setFromObject(obj); center.copy(box.getCenter(new THREE.Vector3())); const size=box.getSize(new THREE.Vector3()); radius=Math.max(size.x,size.y,size.z)*1.6||5; upd(); };
    }

    function showFbxByIndex(idx){ if(!fbxFiles[idx])return; document.getElementById('lodSelect').value=idx; showFBX(fbxFiles[idx].content, fbxFiles[idx].fileName); }
    function showFBX(content, name){
      ensureThree();
      if (currentMesh) {
        scene.remove(currentMesh);
        currentMesh.traverse(o => { if(o.geometry) o.geometry.dispose(); if(o.material) (Array.isArray(o.material)?o.material.forEach(m=>m.dispose()):o.material.dispose()); });
        currentMesh=null;
      }
      const url = URL.createObjectURL(new Blob([content], {type:'application/octet-stream'}));
      const loader = new THREE.FBXLoader();
      loader.load(url, mesh=>{
        mesh.traverse(o=>{ if(o.isMesh && !Array.isArray(o.material)) o.material=new THREE.MeshStandardMaterial({ color:0xdddddd, metalness:0, roughness:0.85 }); });
        currentMesh = mesh; scene.add(mesh); ensureThree.updateTo(mesh); URL.revokeObjectURL(url); applyViewMode(currentMode);
      }, undefined, err=>{ alert('FBX load error: ' + err); });
    }

    document.getElementById('viewModeButtons').onclick = e => { if(e.target.tagName!=='BUTTON')return; applyViewMode(e.target.dataset.mode); };
    function applyViewMode(mode){
      currentMode=mode; if(!currentMesh)return;
      currentMesh.traverse(o=>{
        if(!o.isMesh)return;
        if(mode==='wire'){ o.material.wireframe=true; o.material.color.setHex(0x3a3a3a); }
        else if(mode==='gray'){ o.material.wireframe=false; o.material.color.setHex(0xbdbdbd); o.material.metalness=0; o.material.roughness=0.9; }
        else { o.material.wireframe=false; o.material.color.setHex(0xdddddd); o.material.metalness=0; o.material.roughness=0.85; }
        o.material.needsUpdate=true;
      });
    }

    function formatSize(b){ if(b<1024)return b+' B'; if(b<1048576)return (b/1024).toFixed(1)+' KB'; return (b/1048576).toFixed(2)+' MB'; }
    async function downloadZip(ext, files){ const zip=new JSZip(); files.forEach(f=>zip.file(f.path.split('/').pop(), f.content)); const blob=await zip.generateAsync({type:'blob'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=ext + '_files.zip'; a.click(); }
    function downloadAny(path, content){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([content])); a.download=path.split('/').pop(); a.click(); }

    function previewTiff(content) {
      const buf = content instanceof Uint8Array ? content : new Uint8Array(content);
      try {
        const ifds = UTIF.decode(buf);
        if (!ifds || !ifds.length) throw 'bad tiff';
        const first = ifds[0];
        UTIF.decodeImage(buf, first);
        const rgba = UTIF.toRGBA8(first);
        const w = first.width || first.t256, h = first.height || first.t257;
        const c = document.createElement('canvas');
        c.width = w; c.height = h;
        const ctx = c.getContext('2d');
        const img = ctx.createImageData(w, h);
        img.data.set(rgba);
        ctx.putImageData(img, 0, 0);

        const m = document.getElementById('modal');
        m.style.display = 'block';
        m.innerHTML = `
          <div style="position:fixed;inset:0;background:#0006;display:flex;align-items:center;justify-content:center;"
               onclick="this.style.display='none'">
            <div style="background:#fff;padding:10px;border-radius:8px;max-width:95vw;max-height:90vh;overflow:auto;"></div>
          </div>`;
        m.querySelector('div>div').appendChild(c);
      } catch (e) {
        alert('TIFF preview error');
      }
    }

    function base64ToBytes(b64){ const bin=atob(b64), len=bin.length, out=new Uint8Array(len); for(let i=0;i<len;i++) out[i]=bin.charCodeAt(i); return out; }
  </script>
</body>
</html>
